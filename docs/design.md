# 设计

在[processOn](https://www.processon.com/i/57381ce4e4b08d287472318b)上制作了[一些图](https://www.processon.com/view/link/5a6b6a1ce4b0c2241c7b29c1)，比如功能索引，数据库关系什么的
<iframe id="embed_dom" name="embed_dom" frameborder="0" style="display:block;width:525px; height:245px;" src="https://processon.com/embed/5a6b6a1ce4b0c2241c7b29bd"></iframe>

## 数据库设计
我们现阶段有九张表，分别是用户、用户团队关系、团队、用户图像关系、图像、消息、消息集、文章、算法配置，他们的关系如上图所示。

每个用户可以拥有多篇文章，每个用户有多个会话（消息集），每个回话中包含多条消息，每个用户可以属于多个团队，每个团队也可以有多个用户，每个用户可以有多个图片，每个图片可以被多个用户共享，每个图片有自己的算法配置，每种算法图片可以有多个图片使用。其中的多对多关系有用户图片和用户团队，所以需要额外的两个关系表来维护。

每个表都有一个ID作为数据的唯一标识码，其中的image的id还需要负责作为文件保存在文件系统时候的文件名。接下来介绍数据库中各表除了ID以外的字段所代表的含义。

用户表：username表示用户的用户名。Password是用户密码加密后生成的特征码，非明文密码，保护用户隐私和数据安全。Email是用户的邮箱，用户接收系统高优先级通知以及重置密码时可能会用到（后期如果加上激活账户，也会用到）。Delete表示该用户是否被删除，在web应用中，我们应该尽量避免真删除操作，而是大量的使用lazy_delete来避免潜在的数据丢失，加上delete标记的用户在各种操作进行的时候都会被跳过，但是假如以后有恢复的需求的时候我们还可以恢复，另一方面因为里面包含了各种复杂的外键，我们这么做也可以提高效率，增加数据一致性。Pending标记是冻结用户的意思，该用户还存在，用户列表可以看到他，但是他无法登陆和对网站进行操作。My_teams是一个关系，他名下包含了所有该用户创建的team，且在team表会有一个owner字段指向该用户，表示当前team的拥有者是他。Teams表示当前用户加入的team。Images表示当前用户拥有的image。

用户团队关系表：team_id表示该关系中连接的team是哪一个。User_id表示连接的用户，isleader表示的是该用户是否是该team的管理员（如果不是就是普通群员，群主是否是管理员是无所谓的，因为他是群主，拥有更高的权限，我们默认群主是普通群员，因为群转让后，不涉及关系表的更改，从设计上讲，群主不会变成管理员）。

团队表：title是团队的名称，users团队拥有的用户。

用户图像关系表：isOwner表示当前关系的用户是否对图像有完全的控制权。

图像表：title表示图片的上传时候的名字（会经过一个安全处理，保证下载后也是一样的安全，不会对目标计算机造成潜在的伤害）。Uri表示当前资源在服务器的文件系统的绝对位置，通常是图像ID结尾的。State表示当前图片的状态，主要说明的是当前图片处在标注流程的哪里，是否标注完成，后期可能还会加上多人校验，也会把对应的状态加入这里所限制的常量表ImageState中。Freeze表示该图片被冻结，冻结的图片可以预览不能操作。比如owner不希望别人动他的图片，他就可以把图片冻结上。Delete是删除标记，也是为了避免真删除操作而引入的lazy标记。Users是一个关系，表示可对图片进行操作的用户们。

会话表：title表示该会话的主题。From/to表示的是会话双方用户是谁。Messages是一个关系，表示了该会话所拥有的消息，他的backref属性让他在message表建立一个message_batch字段可以反向引用消息所属的会话。

消息表：type表示这条消息所属的类型，有三种，分别是普通消息，看完就算是看完了；需要回复的消息，回复后才算是已读状态；是否消息，需要给出一个反馈，是或者否。reply_message_id字段表示当前消息回复了哪一条消息，如果没有回复而是普通发表，则为空。From_user_id表示发送用户的ID。Context表示这条message的内容。Created_at是这条消息的发送时间。当我们打开一个messagebatch的时候，我们看到的消息就是按照时间排列的。

文章表：text_nodes是一个关系字段，他会指向多个文字段，这些文字段加起来组成完整的文章，这样设计可以让我们文章的长度对用户是无限制的。Title表示文章的标题。

算法表：alg表示这个算法是从哪种算法派生来的。Title表示这种新算法的名字。Config是一个字符串，里面存的是json格式的字符串，表示的是该算法具体的配置信息，不同的基类派生出来的算法应该由不同的函数去解读。

## 功能设计
### 用户模块
用户模块是一个互联网应用的基础，所有的在线管理都是基于用户来做的。可以说用户是资源划分、数据隔离的最小单位。

用户模块主要由三部分构成，用户的认证、用户的权限控制、管理员的用户管理列表。

用户认证就是注册登录重置密码三个部分。在注册的时候我们会把用户信息填入，对用户的密码进行二次加密，不存储明文来保护用户的数据安全，然后初始化用户的环境（比如为用户建立文件夹分配小组等等）。现在在注册的时候没有限制邮箱的唯一性，是为了方便起见，但是如果系统有一天上线，数据的有效性就是我们需要考虑的问题，我们要避免恶意注册，到时候就需要对邮箱进行校验。邮箱是用户很重要的信息，我们可以通过邮箱和用户取得联系，发送平台的重要信息，为用户重置密码，为用户激活账户等等。登录的时候我们会首先校验用户名知否存在，然后对上传的密码进行二次加密后和数据库存储的迷文进行比对，然后后端在session中保留用户的登录状态，并且给用户分发用于识别登录状态的token（口令）。登出的时候就是把用户的ltoken从session中进行回收。重置密码的有两种途径，管理员进行重置以及用户通过邮件自行重置。

权限控制方面，主要分为是否是系统管理员，是否是小组长，是否被冻结，是否被删除以及是否拥有某个资源这五点。系统管理员可以对系统进行管理，比如对所有用户进行管理，对系统包含的算法场景进行配置。小组长算是小组权限控制里面的概念，在下面的小组部分再叙述。冻结是指账户被管理员冻结，因为某一些原因，我们可能会不希望某个用户保持活跃（可以继续使用系统），最经典的例子就是某一个用户一直发布不当言论，那么这时候我们就需要把这个用户给封禁（也就是冻结）掉。处于冻结状态的用户是无法登录的，登录时候会显示用户已被冻结无法登录。然后就是用户删除，因为某些原因某些用户会希望注销掉自己的账户，这就是用户删除。但是我们不会使用真删除，我们只是给用户加一个删除标记表示已经被删除了，被删除的用户也是无法登录的，在登录的时候会提示用户不存在。然后就是对于资源的权限，我们在访问图片资源前会进行一个权限校验，如果没有对于他的操作权，我们是不会反悔数据的，保护了用户的数据安全。图片资源的赋权是通过分享操作实现的。

用户管理指的是管理员可以获取网站用户的用户列表，并且对其中任意一个用户进行造作。管理员是不能对管理员进行操作的。管理员拥有的操作比如冻结删除重置密码等等。

用户是一个web应用的基石，没有用户这个应用就没有存在的价值，我们应该时刻把用户体验和用户信息安全放在我们心上。

### 组织模块
在实际场景中，用户往往都是成群出现的，比如某一个学校某一个医院某一个组织某一个团体。在一个群体内部可能会有一些公告啊文件共享啊资源共享的情况，如果做成一对一网络形式的话，维护成本太高了而且消息的传递实际上是有空间时间开销的，在这种情况下，team这种数据集合的形式就应运而生。

Team是用户的集合，team有自己的资源，在这个team中的用户对于team资源的权限都是由team控制的，team中的用户有三种，群主、管理员、基层群员。在同一个团队内，有一些资源是共享的，有一些文章是共享的，有一些消息是共享的。团队系统支持对于团队的增加（申请制的），删除（解散），修改（修改团队信息，修改团队成员，修改团队资源，修改团队配置等等）。

### 文章模块
医学作为一个重经验学科，经验的传递是很重要的。而文章就是最常见的形式。除此之外，有些用户可能会写一些自己临时想起来的一闪而过的东西，也会需要这样一个功能。

文章系统的功能比较基础，就是简单的增（写新的文章）删（删除文章）改（编辑文章）查（查询文章）。其中比较有特色值得一说的是，我们对于文章的字数是没有上限要求的。虽然数据库在生命的时候要求是定长的，但是我们通过一个文章节点下面挂载多个内容节点的方式可以实现无感知的动态扩容缩容。给用户一个非常好的用户体验。

### 消息模块
所谓“消息”有一种更常见的叫法叫做“站内信”，它大体上有两个功能：系统向用户发送通知，以及用户之间交流沟通。

我们把站内信做成会话，每一个会话由两个用户共同维护（如果是系统消息，那就是用户和root用户之间的会话），每一个会话有多条消息组成，展示的时候按照时间顺序排序。每条消息有三种形式（为了方便用户），一个就是普通的消息。一个是需要对方回复的消息，一个是是否题，就是对方点击按钮选择回复是或者否。

### 图像模块
图像模块是该平台的核心，图像是属于用户的资源，用户可以上传图片，图片展示，操作图片（分享、冻结、标注），删除图片（当然也是lazy-delete）。

用户上传图片的时候可以选择应用在该图片的场景，这个场景是可以配置的，应用在图片上的预测算法也是基于配置的。图片被上传后，首先处于待标注状态，这时候如果当前配置的场景有已经训练好的模型的权重，那么我们就可以开始进行预测，预测结束的时候，如果图片仍然处于待标注状态，就更新图片的标注信息，并且把图片状态改变为标注完成状态。刚刚说的是上传后没有人类去干预的情况。如果上传后，有人类去对图片进行标注，在点击标注的时候图片的状态更新为标注中，这时候如果预测结束，也是不会更新图片信息的。用户标注完图片点击提交后，标注信息会被保留，同时图片的状态更新为标注完成。图片的标注状态在图片展示的时候会被显示在图片的下方。

除了最核心的标注功能外，我们还可以对图片做一些边缘操作，比如冻结、删除、重命名。被删除的图片永远不会在用户的视野中再出现（最然后台使用的是lazy-delete，如果有需要数据是可以找回的），被冻结的图片的状态不会再变化，无法被算法或者用户进行标记。分享操作可以让上传者给其他用户授权，使得其他用户也可以看到这张图片甚至协助标注。	

### 算法模块
算法模块其表述的可能不是很清楚，这里说的应该是场景模块，就是一个一个的使用场景按照现在的设计是高度可配置的，比如支气管分割，就是一个应用在肺部的的“场景”，但是他底层的实质，是不同的算法在支持，我们也可以把这部分叫做算法模块。

所有的应用场景我们认为可以由四个基本场景拓展出来，分别是：图像分类任务、图像识别任务、图像分割任务、图像说明任务。

所谓的图像分类，就是给定一个图像，我们对其进行类别的判断，类别是提前给好的，最后的结果一定在其中（也有可能不在其中，如果没有一个类别是匹配的，我们就把所有的这种情况归为不存在）。如果类别数为二，那就是经典二分类问题。二分类可以拓展出许多应用场景，比如“是否”类型的检测是否患有肺癌啊，某个病变是否存在之类的。分类任务需要配置的就是类型的数量以及类型的名字。

图像识别是在一个图中找到物体并识别出他的类别，他的输入数据会包含矩形框的坐标和类型标签。这个算法可以对病灶进行粗定位。这种场景可以配置的东西包括潜在标签的数量以及标签的名称。

图像分割任务，就是对每一个像素进行分类，比如血管分割，病灶分割、细胞分割等等。这里可配置的应该是类别的数量以及类别的名称。

图像说明是根据图像生成病例，配置的时候只需要该配置的名称即可。

每一个用户不可能用到所有的场景，比如我就是一个胸外科医生，我只会用到胸部X光片，确定一部分疾病。这里的算法提供了很多，但是针对个人是可以自行添加的，个人上传的图片所属的算法应该提前添加到个人场景中。

这样的设计，让动态需求变更成为可能。
 


# todo_list

还差文章、消息、团队。
UI方面，除了一些老的UI的升级以外，还要把错误值返回放在当页。比如login、register、new_alg、等等
还要加footer
还有UT
celery出了点儿问题
文章可以选择是否公开
场景可以选择是否自动标注

## 开发规范

### 后端代码基于 pep8 规范进行编写

### todo_list 说明
- doing  正在做的，太蠢了所以到现在还没做完
- done  已经完成的bug（bug里面藏代码说的就是我）
- todo 必须做的，完成所有的 todo 立马开始做
- pending  不重要或者有代替方案，完成所有的 todo，就去做
- abandon  没空做啦QAQ，完成所有的 pending 就去做

### git_message 说明
- feat：新功能（feature）
- fix：修补bug
- docs：文档（documentation）
- drop: 删除文件
- test: 添加 UnitTest

## 后端

### 用户 (done)
- Register (done)
  - 创建用户 (done) 
  - 创建用户文件夹 (done)
- Login (done)
- Logout (done)
- permission (系统管理员，用户)
- password encode (todo)
- FindPassword (abandon)
- OAuth2 (abandon)
- 用户画像 或者说用户评级 (pending)
  - 因为经过标注的数据我们无法确定其正确性，如果一个用户正确率越高，我们认为他的话语权越大

### 组织(pending)
同一个组织可以方便的share文件

### 文件 (doing)
```text
这里对于label文件特别说明一下，它和用什么网络(VGG/CNN/restnet)应该是没有关系的，只和图片和图片所属的任务类型有关
结构应该是：
{
    'alg':1001,
    'data':{
        'key':{
            0:'cat',
            1:'dog',
        },
        'value':0.2,
    }
}
alg的取值范围在my_app.common.constant.ImageAlgorithm
data里面的值通常是各种预定义和当前的值，比如这是一个有猫病的二分类，二分类还有另一种写法，见下
{
    'alg':1001,
    'data':{
        'key':['cat', 'dog'],
        'weight':[0.2, 0.78],
        'value':1
    }
}
这里的 value 保存的是下标，从0开始计数
统一规定，这种写法属于多分类中分类数k = 2的情况
```
- 上传图片 (doing)
  - 选择文件所属的任务类型 (done)
    - 要做成可配置的，每一个抽象下属可增加可删除的细分需求（做成可配置的容易出问题，后期可以考虑迁移的问题）
    ...
  - 上传 (done)
  - 更新db，放入图像，关联用户，获得图像ID （文件处于待标注状态）(done)
  - 在该用户的文件夹下放置文件，uri为image_id.[type]  (done)
  - 为文件添加标注文件，uri为image_id.label（本质是json） (done)
  - 异步任务开始进行预标注（这里有两种实现策略） (doing)
    - 一个是本地跑 (doing)
      - 前提是单张图片本地预标注的时间控制在1分钟内 (doing)
      - 预标注结束后，db里更新图像状态为 DONE_LABEL
    - 一个是发送图片到远程高性能服务器：hiformance/GCP/AWS/Aliyun (pending)
      - 发送图片
      - 做完后访问一个本地的端口，告知成功
        - 本地需要新增一个API
      - 本地API被访问后，db里更新图像状态为 WAIT_LABEL
- 展示 (done)
  - 图片压缩 (pending)(函数ok了，待接入，感觉现在的方式不是很优雅)
  - 下载 (done)
- 下载 (done)
- 删除 (done)
- 冻结 (done)
- 重命名 (done)
- 标注 (done)
  - 不同的任务类型会有不同的前端后端API，后端逻辑见后面的算法章节
- 分享 (pending) (高优先级)
  - 文件本身不会增加，“可编辑uid” append一份
- 给予副本 (abandon)
  - 文件本身不会拷贝，uri不变，生成新的fid
  
### 消息 (pending) (高优先级)
- 给xxx发消息
- 显示消息
  - 为了加速，消息采用了并查集+链表进行设计
- 回复某条消息

### 文章 (pending)
- 发布文章
  - 如果文章过长，会存成链表的样子
- 编辑文章
  - 编辑内容
  - 删除
  - 冻结

### 算法 (doing)
- 算法
  - classification (done)
    ```python
    config = {
        'class_cnt': int,
        'labels': [str]
    }
    label = [float]  # 属于每个类别的可能性
    ```
  - detection (pending)
    ```python
    config = {
        'class_cnt': int,
        'labels': [str]
    }
    data = [((x1,y1),(x2,y2),str)]  # 每一个矩形框的坐标和标签
    ```
    - 病灶识别
    - 异物识别
  - segmentation (pending)
  ```python
    config = {
        'class_cnt': int,
        'labels': [str]
    }
    data = [((x1,y1),str)]  # 每一个像素的分类
    ```
    - 病灶分割
    - 器官分割
    - 血管分割
    - 细胞分割
  - caption
  ```python
    config = {}  # 不需要任何设置
    data = str  # 病例
    ```
- 行为(doing)
  - 这里要加一个针对毕设演示的后门，训练成本太高了
  - 标注(done)
    - 前端解析图片对应的label文件存储的信息作为初始值
    - 提交标注后修改图片对应的label文件
  - 训练(pending) (高优先级)
    - 按照配置的时间循环的进行训练
    - 训练的时候有个坑，
  - 预标注(doing)
    - 图片被上传的时候就会进行预测，把结果存入label文件

### Unittest （pending）

## 前端 (abandon)
- 我的前端跟`屎`一样我没啥想说的
  - 本来是想用iview的，暂时不想了，随缘吧
  - 写完论文后用 bootstrap 看情况美化一下吧

## 其他 (pending)
- 高可用
  - 自动化部署 (git-cli)
  - 容器 (docker)
- 高并发
  - 负载均衡 (nginx)
  - 分布式部署 (k8s)
- CDN
- AliyunOSS

## 论文（done）

留了两个坑，一个是textnode可以是article的，也可以是message 的，测试一下是否可以两边同时backref过去
新增了一些alg，该没有对应的算法填入

想做成非营利组织接入23333（梦里什么都有）









